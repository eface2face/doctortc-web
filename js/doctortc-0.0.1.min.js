!function(a){var b=function(){"use strict";var a;return a={settings:{verbose:!1}},Object.defineProperties(a,{title:{get:function(){return"DoctoRTC.js"}},titleLowCase:{get:function(){return"doctortc.js"}},name:{get:function(){return"doctortc"}},version:{get:function(){return"0.0.1"}}}),a.setVerbose=function(b){a.settings.verbose=b},a.hasWebRTC=function(){return a.Adaptor.getUserMedia&&a.Adaptor.RTCPeerConnection&&a.Adaptor.RTCSessionDescription?!0:!1},a.testNetwork=function(b,c,d,e){new a.NetworkTester(b,c,d,e)},a.debug=function(b,c,d){a.settings.verbose&&console.debug("[DEBUG] "+a.titleLowCase+" | "+b+"."+c+"()"+(d?" | "+d:""))},a.log=function(b,c,d){console.log("[LOG]   "+a.titleLowCase+" | "+b+"."+c+"()"+(d?" | "+d:""))},a.warn=function(b,c,d){console.warn("[WARN]  "+a.titleLowCase+" | "+b+"."+c+"()"+(d?" | "+d:""))},a.error=function(b,c,d){console.error("[ERROR] "+a.titleLowCase+" | "+b+"."+c+"()"+(d?" | "+d:""))},a.throw=function(b,c,d){throw"[THROW] "+a.titleLowCase+" | "+b+"."+c+"()"+(d?" | "+d:"")},a}();!function(b){var c;c={},a.navigator.getUserMedia?c.getUserMedia=a.navigator.getUserMedia.bind(navigator):a.navigator.webkitGetUserMedia?c.getUserMedia=a.navigator.webkitGetUserMedia.bind(navigator):a.navigator.mozGetUserMedia&&(c.getUserMedia=a.navigator.mozGetUserMedia.bind(navigator)),a.RTCPeerConnection?c.RTCPeerConnection=a.RTCPeerConnection:a.webkitRTCPeerConnection?c.RTCPeerConnection=a.webkitRTCPeerConnection:a.mozRTCPeerConnection&&(c.RTCPeerConnection=a.mozRTCPeerConnection),a.RTCSessionDescription?c.RTCSessionDescription=a.RTCSessionDescription:a.webkitRTCSessionDescription?c.RTCSessionDescription=a.webkitRTCSessionDescription:a.mozRTCSessionDescription&&(c.RTCSessionDescription=a.mozRTCSessionDescription),a.RTCIceCandidate?c.RTCIceCandidate=a.RTCIceCandidate:a.webkitRTCIceCandidate?c.RTCIceCandidate=a.webkitRTCIceCandidate:a.mozRTCIceCandidate&&(c.RTCIceCandidate=a.mozRTCIceCandidate),c.RTCPeerConnection&&c.RTCPeerConnection.prototype&&(c.RTCPeerConnection.prototype.getLocalStreams||(c.RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},c.RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})),b.Adaptor=c}(b),function(b){var c,d="NetworkTester",e={CONNECTION_TIMEOUT:"CONNECTION TIMEOUT",TEST_TIMEOUT:"TEST TIMEOUT",INTERNAL_ERROR:"INTERNAL ERROR"},f={DATACHANNEL_MAX_RETRANSMIT_TIME:0,CONNECT_TIMEOUT:4e3,TEST_TIMEOUT:8e3,START_MESSAGE_INTERVAL:100,SENDING_INTERVAL:20,END_MESSAGE_INTERVAL:100,NUM_PACKETS:100,PACKET_SIZE:500,IGNORED_INTERVAL:2e3},g={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1}};c=function(c,d,e,h){this.callback=d,this.errback=e,h=h||{};var i=this;this.connectTimeout=h.connectTimeout||f.CONNECT_TIMEOUT,this.connectTimer=null,this.testTimeout=h.testTimeout||f.TEST_TIMEOUT,this.testTimer=null,this.startMessageInterval=f.START_MESSAGE_INTERVAL,this.startMessagePeriodicTimer=null,this.sendingInterval=h.sendingInterval||f.SENDING_INTERVAL,this.sendingTimer=null,this.sendingTimeout=0,this.endMessageInterval=f.END_MESSAGE_INTERVAL,this.endMessagePeriodicTimer=null,this.onPacketReceived=h.onPacketReceived,this.numPackets=h.numPackets||f.NUM_PACKETS,this.ignoredInterval=0===h.ignoredInterval?0:h.ignoredInterval||f.IGNORED_INTERVAL;var j=this.numPackets*this.sendingInterval;if(this.ignoredInterval>j/2)throw"'ignoredInterval' ("+this.ignoredInterval+" ms) is too high";this.packetSize=h.packetSize||f.PACKET_SIZE,this.packetSize%2!==0&&this.packetSize++,this.packet=new Int16Array(this.packetSize/2),this.packetsInfo=new Array(this.numPackets),this.numPacketsSent=0,this.numPacketsReceived=0,this.pendingOngoingData=[],this.sendingPacketId=0,this.highestReceivedPacketId=-1,this.outOfOrderReceivedPackets=0,this.testBeginTime=null,this.validTestBeginTime=null,this.dc1Open=!1,this.dc2Open=!1,this.testEnded=!1,c.urls?c.url=c.urls:c.url&&(c.urls=c.url),h.turnServer2&&h.turnServer2.urls?h.turnServer2.url=h.turnServer2.urls:h.turnServer2&&h.turnServer2.url&&(h.turnServer2.urls=h.turnServer2.url);var k=h.turnServer2||c,l={iceServers:[c]},m={iceServers:[k]};this.pc1=new b.Adaptor.RTCPeerConnection(l),this.pc2=new b.Adaptor.RTCPeerConnection(m),this.pc1.onicecandidate=function(a){i.onIceCandidate1(a)},this.pc2.onicecandidate=function(a){i.onIceCandidate2(a)};var n={ordered:!1,maxRetransmits:0,negotiated:!0,id:"DoctoRTC.NetworkTester"};this.dc1=this.pc1.createDataChannel("Channel 1",n),this.dc2=this.pc2.createDataChannel("Channel 2",n),this.dc1.binaryType="arraybuffer",this.dc2.binaryType="arraybuffer",this.dc1.onopen=function(){i.onOpen1()},this.dc2.onopen=function(){i.onOpen2()},this.dc1.onmessage=function(a){i.onMessage1(a)},this.dc2.onmessage=function(a){i.onMessage2(a)},this.pc1.createOffer(function(a){i.onCreateOfferSuccess1(a)},function(a){i.onCreateOfferError1(a)},g),this.connectTimer=a.setTimeout(function(){i.onConnectionTimeout()},this.connectTimeout)},c.prototype.close=function(c){b.debug(d,"close");try{this.dc1.close()}catch(e){}try{this.dc2.close()}catch(e){}try{this.pc1.close()}catch(e){}try{this.pc2.close()}catch(e){}this.pc1=null,this.pc2=null,this.packet=null,a.clearTimeout(this.connectTimer),a.clearTimeout(this.testTimer),a.clearTimeout(this.sendingTimer),a.clearInterval(this.startMessagePeriodicTimer),a.clearInterval(this.endMessagePeriodicTimer),c&&this.errback(c)},c.prototype.onCreateOfferSuccess1=function(a){a.sdp=a.sdp.replace(/^a=candidate.*\r\n/gm,""),b.debug(d,"onCreateOfferSuccess1","offer:\n\n"+a.sdp+"\n");var c=this;this.pc1.setLocalDescription(a),this.pc2.setRemoteDescription(a),this.pc2.createAnswer(function(a){c.onCreateAnswerSuccess2(a)},function(a){c.onCreateAnswerError2(a)},g)},c.prototype.onCreateOfferError1=function(a){b.error(d,"onCreateOfferError1","error: "+a),this.close(e.INTERNAL_ERROR)},c.prototype.onCreateAnswerSuccess2=function(a){a.sdp=a.sdp.replace(/^a=candidate.*\r\n/gm,""),b.debug(d,"onCreateAnswerSucess2","answer:\n\n"+a.sdp+"\n"),this.pc2.setLocalDescription(a),this.pc1.setRemoteDescription(a)},c.prototype.onCreateAnswerError2=function(a){b.error(d,"onCreatAnswerError2","error: "+a),this.close(e.INTERNAL_ERROR)},c.prototype.onIceCandidate1=function(a){a.candidate&&a.candidate.candidate.match("relay")?(b.debug(d,"onIceCandidate1","adding TURN candidate into pc2: "+a.candidate.candidate),this.pc2.addIceCandidate(a.candidate)):!a.candidate&&this.pc1&&b.debug(d,"onIceCandidate1","no more ICE candidates")},c.prototype.onIceCandidate2=function(a){a.candidate&&a.candidate.candidate.match("relay")?(b.debug(d,"onIceCandidate2","adding TURN candidate into pc1 "+a.candidate.candidate),this.pc1.addIceCandidate(a.candidate)):!a.candidate&&this.pc2&&b.debug(d,"onIceCandidate2","no more ICE candidates")},c.prototype.onOpen1=function(){b.debug(d,"onOpen1","DataChannel 1 connected"),this.dc1Open=!0,this.dc2Open&&(a.clearTimeout(this.connectTimer),this.startTest())},c.prototype.onOpen2=function(){b.debug(d,"onOpen2","DataChannel 2 connected"),this.dc2Open=!0,this.dc1Open&&(a.clearTimeout(this.connectTimer),this.startTest())},c.prototype.onConnectionTimeout=function(){b.error(d,"onConnectionTimeout","timeout connecting to the TURN server"),this.close(e.CONNECTION_TIMEOUT)},c.prototype.onMessage1=function(){b.error(d,"onMessage1","unexpected message received"),this.close(e.INTERNAL_ERROR)},c.prototype.startTest=function(){b.debug(d,"startTest"),this.testBeginTime=new Date,this.sendTestPackets()},c.prototype.sendTestPackets=function(){b.debug(d,"sendTestPackets");var c=this;this.sendingTimer=a.setTimeout(function(){var a=new Date,e=c.sendTestPacket(),f=new Date-a;f>2&&b.warn(d,"sendTestPackets","DataChannel.send() took "+f+" ms"),c.numPacketsSent===c.numPackets?(b.debug(d,"sendTestPackets","all the packets sent"),c.sendEndMessage()):(e?(c.sendingTimeout=c.sendingInterval-f,c.sendingTimeout<2&&(c.sendingTimeout=2)):c.sendingTimeout=2,c.sendTestPackets())},this.sendingTimeout)},c.prototype.sendTestPacket=function(){if(b.debug(d,"sendTestPacket","sending packet with id "+this.sendingPacketId),0!==this.dc1.bufferedAmount)return b.warn(d,"sendTestPacket","sending buffer not empty"),!1;this.packet[0]=this.sendingPacketId;try{this.dc1.send(this.packet)}catch(a){return b.error(d,"sendTestPacket","error sending packet with id "+this.sendingPacketId+": "+a.message),!1}var c=new Date-this.testBeginTime;this.packetsInfo[this.sendingPacketId]={sentTime:c,recvTime:null,elapsedTime:null},b.debug(d,"sendTestPacket","sent packet with id "+this.sendingPacketId+" ("+(this.sendingPacketId+1)+"/"+this.numPackets+")"),c<=this.ignoredInterval?this.packetsInfo[this.sendingPacketId].ignored=!0:this.validTestBeginTime||(this.validTestBeginTime=new Date),this.sendingPacketId++,this.numPacketsSent++;var e=(this.numPacketsSent-this.numPacketsReceived)*this.packetSize;return this.pendingOngoingData.push([c,e]),!0},c.prototype.sendEndMessage=function(){b.debug(d,"sendEndMessage");var c=this;this.endMessagePeriodicTimer=a.setInterval(function(){c.dc1.send("END")},f.END_MESSAGE_INTERVAL)},c.prototype.onMessage2=function(a){if(a.data.byteLength===this.packetSize){var c=new Int16Array(a.data),g=c[0];if(-1===g)return void b.debug(d,"onMessage2","ignoring pre-test received packet");if(b.debug(d,"onMessage2","received packet with id "+g),g>=this.packetsInfo.length)return b.error(d,"onMessage2","malformed packet with unknown id "+g),void this.close(f.INTERNAL_ERROR);var h=this.packetsInfo[g],i=new Date-this.testBeginTime;if(h.recvTime)return void b.warn(d,"onMessage2","retransmission received (MUST NOT happen in DataChannels!) for packet "+g);this.numPacketsReceived++;var j=(this.numPacketsSent-this.numPacketsReceived)*this.packetSize;if(this.pendingOngoingData.push([i,j]),g>this.highestReceivedPacketId?this.highestReceivedPacketId=g:h.ignored||(b.debug(d,"onMessage2","packet "+g+" received our of order"),this.outOfOrderReceivedPackets++),h.recvTime=i,h.elapsedTime=h.recvTime-h.sentTime,this.onPacketReceived&&this.onPacketReceived(g+1,this.numPackets),this.numPacketsReceived===this.numPackets){if(this.testEnded)return;b.debug(d,"onMessage2","received packet is the last one, end the test"),this.testEnded=!0,this.close(),this.endTest()}}else if("END"===a.data){if(this.testEnded)return;b.debug(d,"onMessage2","END message received, end the test"),this.testEnded=!0,this.close(),this.endTest()}else b.error(d,"onMessage2","unexpected message received"),this.close(e.INTERNAL_ERROR)},c.prototype.onTestTimeout=function(){b.debug(d,"onTestTimeout","test timeout"),this.close(e.TEST_TIMEOUT)},c.prototype.endTest=function(){b.debug(d,"endTest");var a,c={};c.testDuration=(new Date-this.validTestBeginTime).toFixed(3),c.ignoredInterval=this.ignoredInterval;var e=0;for(a=0;a<this.numPackets;a++)this.packetsInfo[a].ignored||e++;c.numPackets=e,c.packetSize=this.packetSize,c.sendingInterval=this.sendingInterval,c.outOfOrder=100*(this.outOfOrderReceivedPackets/c.numPackets).toFixed(5);var f=0,g=0;for(a=0;a<this.numPackets;a++){var h=this.packetsInfo[a];h.ignored||(h.recvTime?g+=h.recvTime-h.sentTime:f++)}c.packetLoss=100*(f/c.numPackets).toFixed(2),c.RTT=(g/(c.numPackets-f)).toFixed(3);var i=8*c.packetSize/1e3*(c.numPackets-f),j=c.testDuration/1e3-c.RTT/1e3/2;c.bandwidth=(i/j).toFixed(2),c.optimalTestDuration=(c.numPackets*c.sendingInterval/1e3).toFixed(3),c.optimalBandwidth=(8*c.packetSize/1e3*c.numPackets/c.optimalTestDuration).toFixed(2),this.callback(c,this.packetsInfo,this.pendingOngoingData)},b.NetworkTester=c}(b),a.DoctoRTC=b}(window);